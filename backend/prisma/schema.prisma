generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ProductType {
  single
  set
}

enum OrderStatus {
  unpaid
  paid
  served
  expired
}

enum SessionStatus {
  active
  expired
}

enum UserRole {
  admin
  staff
}

model Product {
  id              String             @id @default(cuid())
  name            String
  description     String?
  priceTaxIncl    Decimal            @map("price_tax_incl") @db.Decimal(10, 2)
  imageUrl        String?            @map("image_url")
  category        String
  productType     ProductType        @default(single) @map("product_type")
  isAvailable     Boolean            @default(true) @map("is_available")
  displayOrder    Int                @default(0) @map("display_order")
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")
  
  toppings        ProductTopping[]
  orderItems      OrderItem[]
  setComponents   SetComponent[]     @relation("ComponentProduct")
  parentSets      SetComponent[]     @relation("SetProduct")
  
  @@map("products")
}

model Topping {
  id              String             @id @default(cuid())
  name            String
  priceTaxIncl    Decimal            @map("price_tax_incl") @db.Decimal(10, 2)
  isAvailable     Boolean            @default(true) @map("is_available")
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")
  
  products        ProductTopping[]
  orderItems      OrderItemTopping[]
  
  @@map("toppings")
}

model ProductTopping {
  productId       String             @map("product_id")
  toppingId       String             @map("topping_id")
  product         Product            @relation(fields: [productId], references: [id], onDelete: Cascade)
  topping         Topping            @relation(fields: [toppingId], references: [id], onDelete: Cascade)
  
  @@id([productId, toppingId])
  @@map("product_toppings")
}

model SetComponent {
  id              String             @id @default(cuid())
  setProductId    String             @map("set_product_id")
  componentProductId String          @map("component_product_id")
  required        Boolean            @default(true)
  minQty          Int                @default(1) @map("min_qty")
  maxQty          Int                @default(1) @map("max_qty")
  defaultQty      Int                @default(1) @map("default_qty")
  extraPrice      Decimal?           @map("extra_price") @db.Decimal(10, 2)
  slotName        String?            @map("slot_name")
  displayOrder    Int                @default(0) @map("display_order")
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")
  
  setProduct      Product            @relation("SetProduct", fields: [setProductId], references: [id], onDelete: Cascade)
  componentProduct Product           @relation("ComponentProduct", fields: [componentProductId], references: [id], onDelete: Cascade)
  
  @@map("set_components")
}

model Order {
  id              String             @id @default(cuid())
  orderNumber     String             @unique @map("order_number")
  tableNo         String             @map("table_no")
  subtotal        Decimal            @db.Decimal(10, 2)
  tax             Decimal            @db.Decimal(10, 2)
  total           Decimal            @db.Decimal(10, 2)
  status          OrderStatus        @default(unpaid)
  sessionTokenId  String             @map("session_token_id")
  idempotencyKey  String?            @unique @map("idempotency_key")
  notes           String?
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")
  paidAt          DateTime?          @map("paid_at")
  servedAt        DateTime?          @map("served_at")
  
  sessionToken    SessionToken       @relation(fields: [sessionTokenId], references: [id])
  items           OrderItem[]
  
  @@index([tableNo])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id              String             @id @default(cuid())
  orderId         String             @map("order_id")
  productId       String             @map("product_id")
  quantity        Int
  unitPrice       Decimal            @map("unit_price") @db.Decimal(10, 2)
  totalPrice      Decimal            @map("total_price") @db.Decimal(10, 2)
  parentItemId    String?            @map("parent_item_id")
  createdAt       DateTime           @default(now()) @map("created_at")
  
  order           Order              @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product         Product            @relation(fields: [productId], references: [id])
  parentItem      OrderItem?         @relation("ParentChild", fields: [parentItemId], references: [id])
  childItems      OrderItem[]        @relation("ParentChild")
  toppings        OrderItemTopping[]
  
  @@map("order_items")
}

model OrderItemTopping {
  orderItemId     String             @map("order_item_id")
  toppingId       String             @map("topping_id")
  quantity        Int                @default(1)
  unitPrice       Decimal            @map("unit_price") @db.Decimal(10, 2)
  
  orderItem       OrderItem          @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  topping         Topping            @relation(fields: [toppingId], references: [id])
  
  @@id([orderItemId, toppingId])
  @@map("order_item_toppings")
}

model Table {
  id              String             @id @default(cuid())
  number          String             @unique
  name            String?
  qrUrl           String?            @map("qr_url")
  tableToken      String             @unique @map("table_token")
  isActive        Boolean            @default(true) @map("is_active")
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")
  
  sessionTokens   SessionToken[]
  
  @@map("tables")
}

model SessionToken {
  id              String             @id @default(cuid())
  token           String             @unique
  tableId         String             @map("table_id")
  issuedAt        DateTime           @default(now()) @map("issued_at")
  expiresAt       DateTime           @map("expires_at")
  lastActivityAt  DateTime           @default(now()) @map("last_activity_at")
  deviceFingerprint String?          @map("device_fingerprint")
  userAgent       String?            @map("user_agent")
  ipAddress       String?            @map("ip_address")
  status          SessionStatus      @default(active)
  
  table           Table              @relation(fields: [tableId], references: [id])
  orders          Order[]
  
  @@index([status, expiresAt])
  @@map("session_tokens")
}

model TaxRateSchedule {
  id              String             @id @default(cuid())
  rate            Decimal            @db.Decimal(5, 2)
  effectiveFrom   DateTime           @map("effective_from_date")
  createdAt       DateTime           @default(now()) @map("created_at")
  createdBy       String?            @map("created_by")
  
  @@index([effectiveFrom])
  @@map("tax_rate_schedules")
}

model User {
  id              String             @id @default(cuid())
  email           String             @unique
  name            String
  password        String
  role            UserRole           @default(staff)
  isActive        Boolean            @default(true) @map("is_active")
  lastLoginAt     DateTime?          @map("last_login_at")
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")
  
  @@map("users")
}

model AnalyticsDaily {
  id              String             @id @default(cuid())
  date            DateTime           @unique @db.Date
  revenue         Decimal            @db.Decimal(10, 2)
  customers       Int
  orders          Int
  avgOrderValue   Decimal            @map("avg_order_value") @db.Decimal(10, 2)
  topProducts     Json               @map("top_products")
  hourlyData      Json               @map("hourly_data")
  createdAt       DateTime           @default(now()) @map("created_at")
  
  @@index([date])
  @@map("analytics_daily")
}
